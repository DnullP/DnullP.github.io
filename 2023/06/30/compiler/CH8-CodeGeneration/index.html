

<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>代码生成 [ Dnull_P Welcome~ ]</title>
  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/css/Genso.css">
  
  <link rel="stylesheet" href="/css/layout/layout.css">
  
  <link rel="stylesheet" href="/css/layout/navigator.css">
  
  <link rel="stylesheet" href="/css/layout/page-container.css">
  
  <link rel="stylesheet" href="/css/layout/page-cover.css">
  
  <link rel="stylesheet" href="/css/layout/slidebar.css">
  
  <link rel="stylesheet" href="/css/index/index.css">
  
  <link rel="stylesheet" href="/css/index/recommend-card-container.css">
  
  <link rel="stylesheet" href="/css/index/card-container.css">
  
  <link rel="stylesheet" href="/css/index/card.css">
  
  <link rel="stylesheet" href="/css/post/post.css">
  
  <link rel="stylesheet" href="/css/post/idea.css">
  
  <link rel="stylesheet" href="/css/tool/color.css">
  
  
  <script>
    const urlList = ('https://s2.loli.net/2023/07/23/mivfcl7wqgVsYdP.jpg,https://s2.loli.net/2023/07/23/E3uyek7OVlJgtLT.jpg,https://s2.loli.net/2023/07/23/q9skN6cPAZ14fwH.png,https://s2.loli.net/2023/07/23/RedmkprBY81ZhaV.jpg,https://s2.loli.net/2023/07/23/pt1ArR7NqO8vMXl.png,https://s2.loli.net/2023/07/23/MZEW5UCFSBPiNvH.png,https://s2.loli.net/2023/07/23/8urpklSmq6xR5LF.jpg,https://s2.loli.net/2023/07/23/E6Os9tkrRP4FZ7f.jpg,https://s2.loli.net/2023/07/23/IPq4HsZCOfTMGxk.jpg,https://s2.loli.net/2023/07/23/sAhIbjyLeMBgfuw.jpg,https://s2.loli.net/2023/07/23/ipTsxHoDOawRrfM.png,https://s2.loli.net/2023/07/23/eTYKcWz7jb5mqyo.png,https://s2.loli.net/2023/07/23/lHLk3OMeY7qXnTP.jpg,https://s2.loli.net/2023/07/23/u9dvATztknGecmI.jpg,https://s2.loli.net/2023/07/23/calWvPZEbI9tG4o.png,https://s2.loli.net/2023/07/23/MLZr1j7hdDnIHGU.png,https://s2.loli.net/2023/07/23/PlqeV1XpgQrxI8u.jpg,https://s2.loli.net/2023/07/23/uWQXFEBh5iCcNJV.png,https://s2.loli.net/2023/07/23/xjcUksAMvHQVhim.jpg,https://s2.loli.net/2023/07/23/Bd46rfJ2HYhQGkM.jpg,https://s2.loli.net/2023/07/23/1BgtkI3Aw58qrGv.jpg,https://s2.loli.net/2023/07/23/z8naFUvWV7BfKud.jpg,https://s2.loli.net/2023/07/23/Xj4wlzuKTDQOmHh.png,https://s2.loli.net/2023/07/23/mKzLHqPkUWTivAu.png,https://s2.loli.net/2023/07/23/a36bWlVynziMrSU.jpg,https://s2.loli.net/2023/07/23/6ZNUeJAtDCRvWq8.jpg,https://s2.loli.net/2023/07/23/7nGYxgcyoi8aSIR.jpg,https://s2.loli.net/2023/07/23/EVeCvBAt1LOgJSU.jpg,https://s2.loli.net/2023/07/23/onE5MQBPGdzDROh.jpg,https://s2.loli.net/2023/07/23/316kgDancGthANM.jpg,https://s2.loli.net/2023/07/23/oeRXvLm5byqgazF.jpg,https://s2.loli.net/2023/07/23/HXj7NsSW5vyCoIn.jpg,https://s2.loli.net/2023/07/23/sqM2XznWeEol3f4.jpg,https://s2.loli.net/2023/07/23/xGAflC5roSOsJRz.jpg,https://s2.loli.net/2023/07/23/cF2oWANXImMREKx.jpg,https://s2.loli.net/2023/07/23/IqutSTML7EXRza3.jpg,https://s2.loli.net/2023/07/23/zYNG9XHIEfg4quh.png').split(',');
  </script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div class="background">
  

  <img src="https://s2.loli.net/2023/07/23/sAhIbjyLeMBgfuw.jpg" alt="">

  <div class="title-text animate__animated animate__bounce">
    <h1>This is
      <span class="name">
        Dnull_P
      </span>
    </h1>
    Welcome Hell !

  </div>
</div>

<div class="background-coverage">
  <!--Typed text-->
  <div class="background-coverage-text">
    <span id="background-coverage-text">
    </span>
  </div>
</div>

<div class="background-occupation">

</div>

  <div class="navigator">
  <div class="navi-buttom-container">
    
    
  <a href="/" class="navi-buttom">
    <div>
      Home
    </div>
  </a>
  
  
    
  <a href="/about" class="navi-buttom">
    <div>
      About
    </div>
  </a>
  
  
    
  <a href="/contact" class="navi-buttom">
    <div>
      Contact
    </div>
  </a>
  
  
    
    <div class="navi-dropdown">
      <div class="dropbtn">
        post
      </div>
      <div class="dropdown-content">
        
        <a href="/archives">
          Aarchives
        </a>
        
        <a href="/tags">
          Tags
        </a>
        
      </div>
    </div>
  </div>
  
  
</div>

  <div class="page-container">
    <div class="slidebar-warp">
  <div class="slidebar">
    <div class="panel">

      <div class="avatar">
        <img src="/pic/avatar.jpg" alt="">
      </div>

      <div class="info">
        <div class="subinfo-1">
          <div class="subinfo-1-left">
            <div class="subinfo-1-left-info">
              <div class="subinfo-1-left-info-inner">
                <div class="subinfo-1-left-info-front">
                  Post
                </div>
                <div class="subinfo-1-left-info-back random-color">
                  156
                </div>
              </div>
            </div>

            <div class="subinfo-1-left-info">
              <div class="subinfo-1-left-info-inner">
                <div class="subinfo-1-left-info-front">
                  Cate
                </div>
                <div class="subinfo-1-left-info-back random-color">
                  37
                </div>
              </div>
            </div>

            <div class="subinfo-1-left-info">
              <div class="subinfo-1-left-info-inner">
                <div class="subinfo-1-left-info-front">
                  Tag
                </div>
                <div class="subinfo-1-left-info-back random-color">
                  191
                </div>
              </div>
            </div>

          </div>

          <div class="subinfo-1-right">
            <div class="subinfo-1-right-inner">
              <div class="subinfo-1-right-front">
                This Month
              </div>
              <div class="subinfo-1-right-back random-color">
                2
              </div>
            </div>
          </div>
        </div>

        <div class="subinfo-2-wrap">
          <div class="subinfo-2">

            
            <div class="sociallink">
    <a href=https://github.com/DnullP>
      <img src="/svg/github.svg" alt="">
    </a>
</div>
            

          </div>
        </div>
      </div>

      <div class="more-opt">

      </div>

    </div>

    <div class="icon-warp">


      <button class="hide-slidebar-button">
        <img src="/svg/arrow-right-line.svg" id="slideBarArrow">
      </button>


    </div>
  </div>
</div>

    <div class="content">
      <div class="post">
  <h1>代码生成</h1>
  <p>本文不具有教程科普的性质, 只是个人学习过程中的理解记录</p>
<hr>
<p>在得到中间代码以后, 我们可以优化中间代码, 并生成目标代码(一般为汇编代码), 最后通过汇编器生成目标程序</p>
<p>而优化中间代码并生成目标代码部分我们称为后端, 是我们编译器的最后一个阶段</p>
<hr>
<p>代码生成(code generation)包含以下几个重要的部分:</p>
<ul>
<li>instruction selection: 选择指令</li>
<li>register allocation: 寄存器分配</li>
<li>register assignment: 赋值</li>
<li>instruction order: 指令排序</li>
</ul>
<h2 id="instruction-selection"><a href="#instruction-selection" class="headerlink" title="instruction selection"></a>instruction selection</h2><p>我们需要为对应的中间代码选择合适的指令来完成相应的操作</p>
<p>比如我们需要计算一个表达式<code>a = b + c</code>, 我们需要选择<code>add</code>指令来完成加法运算, 而在此之前我们需要将<code>b</code>和<code>c</code>的值分别存入寄存器中, 这又需要选择<code>load</code>指令</p>
<h2 id="register-allocation"><a href="#register-allocation" class="headerlink" title="register allocation"></a>register allocation</h2><p>寄存器的分配是一个复杂的问题, 我们可用的寄存器一般是有限的, 而寄存器中的数据对于CPU来说又可以更快访问, 我们需要选择适合的数据存入寄存器中</p>
<h2 id="register-assignment"><a href="#register-assignment" class="headerlink" title="register assignment"></a>register assignment</h2><p>选择了要存储的数据, 还需要选择存储的寄存器, 如果寄存器还有空余, 直接存取就行了, 但是如果寄存器满了, 我们就需要选择一个寄存器将其内容存入内存中, 然后再将新的数据存入寄存器中</p>
<h2 id="instruction-order"><a href="#instruction-order" class="headerlink" title="instruction order"></a>instruction order</h2><p>有些指令可以优化或者更改顺序, 但是有些指令是不能的, 具体细节和规则都将在下面讨论</p>
<hr>
<h2 id="retargetable-compiler"><a href="#retargetable-compiler" class="headerlink" title="retargetable compiler"></a>retargetable compiler</h2><p>可以从多个指令集生成目标程序的编译器</p>
<h2 id="Virtual-Machine"><a href="#Virtual-Machine" class="headerlink" title="Virtual Machine"></a>Virtual Machine</h2><p>虚拟机, 把字节码实时翻译成机器码运行, 称为即使编译器(just-in-time compiler)</p>
<h2 id="CISC-and-RISC"><a href="#CISC-and-RISC" class="headerlink" title="CISC and RISC"></a>CISC and RISC</h2><ul>
<li>CISC: 一般使用两地址码, 以及更复杂的寻址模式</li>
<li>RISC: 一般使用三地址码</li>
</ul>
<hr>
<h2 id="如何进行寄存器分配"><a href="#如何进行寄存器分配" class="headerlink" title="如何进行寄存器分配"></a>如何进行寄存器分配</h2><p>我们将中间代码表示为一个flow graph, 每个节点表示一个basic block, basic block是由程序的控制流来分割的: 一个basic block的入口只有一个, 一个basic block的出口也只有一个, 除了最后一个basic block, 其余的basic block的出口都是下一个basic block的入口</p>
<p>分割规则如下:</p>
<ul>
<li>if语句分割: 从if处分割基本块, 一般包含then和else两个基本块</li>
<li>循环语句分割: 循环语句的出口连接自己的入口, 并且连接跳出循环后的部分</li>
</ul>
<p>比如以下代码:</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
\\ block1

<span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    b <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    \\ block2
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    b <span class="token operator">=</span> a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    \\ block3
<span class="token punctuation">&#125;</span></code></pre><p>我们可以将其分割为以下几个基本块:</p>
<div class="mermaid">graph LR
    A[entry] --> B[block1]
    B --> C[block2]
    B --> D[block3]
    C --> E[exit]
    D --> E</div><p>然后我们在基本块的出口和入口处按照以下规则标记变量:</p>
<ul>
<li>如果一个变量在基本块中没有被改变(赋值)就被使用了, 那么我们认为这个变量在这个基本块中活跃, 我们将其标记在基本块入口</li>
<li>在出口处连接的所有入口处标记的变量的并集, 我们认为这些变量在出口处活跃, 我们将其标记在基本块出口</li>
</ul>
<p>使用一个全局寄存器(这里的全局指的是全部的基本块)可以让位于<strong>入口</strong>处的变量减少读取的成本, 可以让位于<strong>出口</strong>的变量减少写回内存和重新读取的成本</p>
<h3 id="Ershov数"><a href="#Ershov数" class="headerlink" title="Ershov数"></a>Ershov数</h3><p>Ershov数是用于计算表达式需要的寄存器数的一种方法</p>
<p>现在假设我们已经有一个表达式树, 现在我们按照以下规则计算:</p>
<ul>
<li>所有叶子节点标号为0</li>
<li>只有一个子节点的节点标号与子节点相同</li>
<li>有两个子节点标号不同, 则其标号为较大子节点的标号</li>
<li>有两个子节点标号相同, 则其标号为子节点的标号加1</li>
</ul>
<p>最后根节点的值就是计算表达式需要的寄存器数量, 在计算过程中如果寄存器数量不足, 我们需要将一些变量存到内存中, 在需要时再加载回来</p>
<h3 id="使用DP来生成表达式代码"><a href="#使用DP来生成表达式代码" class="headerlink" title="使用DP来生成表达式代码"></a>使用DP来生成表达式代码</h3><p>我们可以使用DP来生成子表达式的最优代码, 然后再生成整个表达式的最优代码</p>
<p>对于每个子树使用不同数量的寄存器计算, 代价花费是不同的</p>
<hr>
<h2 id="代码的简化"><a href="#代码的简化" class="headerlink" title="代码的简化"></a>代码的简化</h2><h3 id="表达式化简"><a href="#表达式化简" class="headerlink" title="表达式化简"></a>表达式化简</h3><p>DAG图可以用于表示程序的表达式, 并进行相应的优化</p>
<p>比如以下的代码:</p>
<pre class="language-c" data-language="c"><code class="language-c">a <span class="token operator">=</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
b <span class="token operator">=</span> b <span class="token operator">-</span> d<span class="token punctuation">;</span>
c <span class="token operator">=</span> c <span class="token operator">+</span> d<span class="token punctuation">;</span>
e <span class="token operator">=</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span></code></pre><p>我们将其表示为DAG图:</p>
<div class="mermaid">graph TD
    +:e --> -:b
    +:e --> +:c
    +:a --> b0
    +:a --> c0
    -:b --> b0
    -:b --> d0
    +:c --> c0
    +:c --> d0</div><p>其中的<code>d0, b0, c0</code>表示在被赋值前的变量</p>
<p>从上到下, 如果某个根节点在后续并没有被用到, 我们就将其视为<strong>死代码(dead code)</strong>, 可以将其删除</p>
<p>如果两个变量的计算表达式相同, 可以使用同一个节点表示, 从而化简代码, 比如:</p>
<pre class="language-c" data-language="c"><code class="language-c">a <span class="token operator">=</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
b <span class="token operator">=</span> a <span class="token operator">-</span> d<span class="token punctuation">;</span>
c <span class="token operator">=</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
d <span class="token operator">=</span> a <span class="token operator">-</span> d<span class="token punctuation">;</span></code></pre><p>化为DAG:</p>
<div class="mermaid">graph TD
    +:a --> b0
    +:a --> c0
    -:b --> +:a
    -:b --> d0
    +:c --> -:b
    +:c --> c0
    -:d --> +:a
    -:d --> d0</div><p>其中的<code>-:b</code>和<code>-:d</code>可以合并为一个节点, 从而化简代码:</p>
<div class="mermaid">graph TD
    +:a --> b0
    +:a --> c0
    -:bd --> +:a
    -:bd --> d0
    +:c --> -:bd
    +:c --> c0
</div><h3 id="Peephole优化"><a href="#Peephole优化" class="headerlink" title="Peephole优化"></a>Peephole优化</h3><p>窥孔优化</p>
<p>我们使用一个窗口, 从上至下扫描代码, 对于代码中出现的特定结构进行优化, 就称为窥孔优化, 这种优化可以优化表达式以外的更多代码语句</p>
<p>其中的优化包括了:</p>
<ul>
<li>冗余指令删除</li>
<li>控制流优化</li>
<li>代数化简</li>
<li>机器特有指令使用</li>
</ul>
<hr>
<h2 id="代码生成的顺序"><a href="#代码生成的顺序" class="headerlink" title="代码生成的顺序"></a>代码生成的顺序</h2><p>我们构造DAG中有<code>a</code>和<code>a0</code>, 其中的<code>a0</code>表示<code>a</code>在被赋值前的值, 所以在<code>a</code>的赋值语句之后, 新的<code>a</code>节点取代了<code>a0</code>节点, 我们称<code>a0</code>节点被<strong>杀死</strong>了</p>
<p>这里需要特别注意的是指针的使用:</p>
<ul>
<li>在<code>=*</code>之前的所有值都要当作被<code>=*</code>操作使用过, 这影响到死代码消除</li>
<li><code>*=</code>会<strong>杀死</strong>所有的之前的节点</li>
</ul>
<p>由于数组和指针有着相似原理, 所以:</p>
<ul>
<li><code>[]=</code>会杀死所有的<code>=[]</code>的节点</li>
</ul>
<hr>
<h2 id="代码的生成"><a href="#代码的生成" class="headerlink" title="代码的生成"></a>代码的生成</h2><p>讨论过寄存器的分配, 代码化简和生成顺序后, 代码可以按照基本块来生成</p>
<p>此外, 我们通过为每个寄存器维护一个表, 我们称为Register Descriptor(寄存器描述符), 用来表示有哪些变量的值可以用这个寄存器来表示</p>
<p>相对的, 我们也为每个变量维护一个表, 我们称为Address Descriptor(地址描述符), 用来表示这个变量的值可以在哪些寄存器获得</p>
<h3 id="通过树生成代码"><a href="#通过树生成代码" class="headerlink" title="通过树生成代码"></a>通过树生成代码</h3><p>我们通过解析代码树中的某些结构, 来生成对应的代码, 其中解析树可以使用前缀表达式来表示, 于是这最后变成了一个SDT的问题, 我们需要制定相应的语法制导方案</p>
<hr>
<h2 id="局部代码优化和全局代码优化"><a href="#局部代码优化和全局代码优化" class="headerlink" title="局部代码优化和全局代码优化"></a>局部代码优化和全局代码优化</h2><p>以上的表达式化简, 窥孔优化, 寄存器分配优化都是基于局部的代码优化, 也就是只是在basic block中进行的优化</p>
<p>在第九章中将进行全局代码优化的讨论, 全局代码优化是在完成了局部代码优化后, 对整个程序进行优化<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"></p>

</div>

<div id="paginator">
  
</div>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({
    securityLevel: 'loose',
    theme: 'forest',
  });
</script>


<!-- scripts list from theme config.yml -->

<script src="/js/post/mermaid.js"></script>


    </div>

  </div>



  
  <!-- scripts list from theme config.yml -->
  
  <script src="/js/layout/animation.js"></script>
  
  <script src="/js/layout/svg.js"></script>
  
  <script src="/js/csstool.js"></script>
  
  

</body>

</html>