

<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>优化程序性能 [ Dnull_P Welcome~ ]</title>
  
  <!-- stylesheets list from _config.yml -->
  
  <link rel="stylesheet" href="/css/Genso.css">
  
  <link rel="stylesheet" href="/css/layout/layout.css">
  
  <link rel="stylesheet" href="/css/layout/navigator.css">
  
  <link rel="stylesheet" href="/css/layout/page-container.css">
  
  <link rel="stylesheet" href="/css/layout/page-cover.css">
  
  <link rel="stylesheet" href="/css/layout/slidebar.css">
  
  <link rel="stylesheet" href="/css/index/index.css">
  
  <link rel="stylesheet" href="/css/index/recommend-card-container.css">
  
  <link rel="stylesheet" href="/css/index/card-container.css">
  
  <link rel="stylesheet" href="/css/index/card.css">
  
  <link rel="stylesheet" href="/css/post/post.css">
  
  <link rel="stylesheet" href="/css/post/idea.css">
  
  <link rel="stylesheet" href="/css/tool/color.css">
  
  
  <script>
    const urlList = ('https://s2.loli.net/2023/07/23/mivfcl7wqgVsYdP.jpg,https://s2.loli.net/2023/07/23/E3uyek7OVlJgtLT.jpg,https://s2.loli.net/2023/07/23/q9skN6cPAZ14fwH.png,https://s2.loli.net/2023/07/23/RedmkprBY81ZhaV.jpg,https://s2.loli.net/2023/07/23/pt1ArR7NqO8vMXl.png,https://s2.loli.net/2023/07/23/MZEW5UCFSBPiNvH.png,https://s2.loli.net/2023/07/23/8urpklSmq6xR5LF.jpg,https://s2.loli.net/2023/07/23/E6Os9tkrRP4FZ7f.jpg,https://s2.loli.net/2023/07/23/IPq4HsZCOfTMGxk.jpg,https://s2.loli.net/2023/07/23/sAhIbjyLeMBgfuw.jpg,https://s2.loli.net/2023/07/23/ipTsxHoDOawRrfM.png,https://s2.loli.net/2023/07/23/eTYKcWz7jb5mqyo.png,https://s2.loli.net/2023/07/23/lHLk3OMeY7qXnTP.jpg,https://s2.loli.net/2023/07/23/u9dvATztknGecmI.jpg,https://s2.loli.net/2023/07/23/calWvPZEbI9tG4o.png,https://s2.loli.net/2023/07/23/MLZr1j7hdDnIHGU.png,https://s2.loli.net/2023/07/23/PlqeV1XpgQrxI8u.jpg,https://s2.loli.net/2023/07/23/uWQXFEBh5iCcNJV.png,https://s2.loli.net/2023/07/23/xjcUksAMvHQVhim.jpg,https://s2.loli.net/2023/07/23/Bd46rfJ2HYhQGkM.jpg,https://s2.loli.net/2023/07/23/1BgtkI3Aw58qrGv.jpg,https://s2.loli.net/2023/07/23/z8naFUvWV7BfKud.jpg,https://s2.loli.net/2023/07/23/Xj4wlzuKTDQOmHh.png,https://s2.loli.net/2023/07/23/mKzLHqPkUWTivAu.png,https://s2.loli.net/2023/07/23/a36bWlVynziMrSU.jpg,https://s2.loli.net/2023/07/23/6ZNUeJAtDCRvWq8.jpg,https://s2.loli.net/2023/07/23/7nGYxgcyoi8aSIR.jpg,https://s2.loli.net/2023/07/23/EVeCvBAt1LOgJSU.jpg,https://s2.loli.net/2023/07/23/onE5MQBPGdzDROh.jpg,https://s2.loli.net/2023/07/23/316kgDancGthANM.jpg,https://s2.loli.net/2023/07/23/oeRXvLm5byqgazF.jpg,https://s2.loli.net/2023/07/23/HXj7NsSW5vyCoIn.jpg,https://s2.loli.net/2023/07/23/sqM2XznWeEol3f4.jpg,https://s2.loli.net/2023/07/23/xGAflC5roSOsJRz.jpg,https://s2.loli.net/2023/07/23/cF2oWANXImMREKx.jpg,https://s2.loli.net/2023/07/23/IqutSTML7EXRza3.jpg,https://s2.loli.net/2023/07/23/zYNG9XHIEfg4quh.png').split(',');
  </script>

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div class="background">
  

  <img src="https://s2.loli.net/2023/07/23/xjcUksAMvHQVhim.jpg" alt="">

  <div class="title-text animate__animated animate__bounce">
    <h1>This is
      <span class="name">
        Dnull_P
      </span>
    </h1>
    Welcome Hell !

  </div>
</div>

<div class="background-coverage">
  <!--Typed text-->
  <div class="background-coverage-text">
    <span id="background-coverage-text">
    </span>
  </div>
</div>

<div class="background-occupation">

</div>

  <div class="navigator">
  <div class="navi-buttom-container">
    
    
  <a href="/" class="navi-buttom">
    <div>
      Home
    </div>
  </a>
  
  
    
  <a href="/about" class="navi-buttom">
    <div>
      About
    </div>
  </a>
  
  
    
  <a href="/contact" class="navi-buttom">
    <div>
      Contact
    </div>
  </a>
  
  
    
    <div class="navi-dropdown">
      <div class="dropbtn">
        post
      </div>
      <div class="dropdown-content">
        
        <a href="/archives">
          Aarchives
        </a>
        
        <a href="/tags">
          Tags
        </a>
        
      </div>
    </div>
  </div>
  
  
</div>

  <div class="page-container">
    <div class="slidebar-warp">
  <div class="slidebar">
    <div class="panel">

      <div class="avatar">
        <img src="/pic/avatar.jpg" alt="">
      </div>

      <div class="info">
        <div class="subinfo-1">
          <div class="subinfo-1-left">
            <div class="subinfo-1-left-info">
              <div class="subinfo-1-left-info-inner">
                <div class="subinfo-1-left-info-front">
                  Post
                </div>
                <div class="subinfo-1-left-info-back random-color">
                  156
                </div>
              </div>
            </div>

            <div class="subinfo-1-left-info">
              <div class="subinfo-1-left-info-inner">
                <div class="subinfo-1-left-info-front">
                  Cate
                </div>
                <div class="subinfo-1-left-info-back random-color">
                  37
                </div>
              </div>
            </div>

            <div class="subinfo-1-left-info">
              <div class="subinfo-1-left-info-inner">
                <div class="subinfo-1-left-info-front">
                  Tag
                </div>
                <div class="subinfo-1-left-info-back random-color">
                  191
                </div>
              </div>
            </div>

          </div>

          <div class="subinfo-1-right">
            <div class="subinfo-1-right-inner">
              <div class="subinfo-1-right-front">
                This Month
              </div>
              <div class="subinfo-1-right-back random-color">
                2
              </div>
            </div>
          </div>
        </div>

        <div class="subinfo-2-wrap">
          <div class="subinfo-2">

            
            <div class="sociallink">
    <a href=https://github.com/DnullP>
      <img src="/svg/github.svg" alt="">
    </a>
</div>
            

          </div>
        </div>
      </div>

      <div class="more-opt">

      </div>

    </div>

    <div class="icon-warp">


      <button class="hide-slidebar-button">
        <img src="/svg/arrow-right-line.svg" id="slideBarArrow">
      </button>


    </div>
  </div>
</div>

    <div class="content">
      <div class="post">
  <h1>优化程序性能</h1>
  <p>这一节主要是解释编译优化的相关内容，如何编写代码，可以使编译器产生更加良好的优化，从而加快程序的速度</p>
<h3 id="编译器的优化"><a href="#编译器的优化" class="headerlink" title="编译器的优化"></a>编译器的优化</h3><p>看看以下两段代码的区别：</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>xp<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>yp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>xp <span class="token operator">+=</span> <span class="token operator">*</span>yp<span class="token punctuation">;</span>
    <span class="token operator">*</span>xp <span class="token operator">+=</span> <span class="token operator">*</span>yp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">fun2</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span>xp<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token operator">*</span>yp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>xp <span class="token operator">+=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token operator">*</span>yp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>一般情况下，<code>fun2</code>的性能比<code>fun1</code>的更好，因为执行更少的读地址操作，但是如果<code>*xp</code>和<code>*yp</code>指向同一个地址，两个函数会产生不一样的效果，所以编译器不会把第一种代码优化成第二种，这便是编译器的保守性——不会为了优化速度而改变代码任何可能改变的逻辑</p>
<p>以上这种情况我们称为<strong>内存别名使用</strong>，在任何对于指针相关的优化中，编译器都必须考虑到这种情况带来的差别</p>
<h4 id="函数的副作用"><a href="#函数的副作用" class="headerlink" title="函数的副作用"></a>函数的副作用</h4><p>考虑以下函数：</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">long</span> <span class="token function">fun3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">fun4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>在<code>f()</code>函数独立存在的情况下，<code>fun4()</code>函数的时空间占用明显更少，但是如果<code>f()</code>函数对于某些全局变量有修改的话，那么<code>fun3()</code>需要保证四次<code>f()</code>函数全部执行，这样的情况我们称为<strong>函数的副作用</strong></p>
<h3 id="程序性能的表示"><a href="#程序性能的表示" class="headerlink" title="程序性能的表示"></a>程序性能的表示</h3><p>CPE —— Cycles Per Element<br>计算每个元素需要的时钟周期</p>
<h4 id="优化程序的性能"><a href="#优化程序的性能" class="headerlink" title="优化程序的性能"></a>优化程序的性能</h4><p><strong>循环展开</strong>：在每次迭代循环中增加操作，从而减少迭代循环的次数，虽然我们直接看来运算次数并没有减少，但是程序的速度变得更快了，具体原因我们会在后面学习</p>
<p><img src="/image/CS/5_1.png"></p>
<p>如图所示，使用了循环展开的程序运行时间，线性上优于原程序，由此可以推测每次的循环迭代有着固定的时间消耗</p>
<p><strong>代码移动</strong>：将每次循环中得到相同结果的部分提取出来，放到循环外面，减少其调用次数</p>
<p>像是<code>strlen()</code>函数需要的时间复杂度就很高，如果每次循环都读取一次字符串的长度，时间消耗巨大</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">1000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>dest <span class="token operator">=</span> <span class="token operator">*</span>dest <span class="token operator">+</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>像上面这种代码进行一次循环时有两次读地址，一次写地址，如果我们把<code>*dest</code>改成一个局部变量，速度将能提升很多</p>
<p>由此可知，<strong>消除不必要的内存读写可以有效提升程序效率</strong></p>
<h3 id="理解现代处理器"><a href="#理解现代处理器" class="headerlink" title="理解现代处理器"></a>理解现代处理器</h3><p><img src="/image/CS/5_2.png"></p>
<p>现代处理器分为两部分，一部分为<strong>指令控制单元（ICU）</strong>，一部分为<strong>执行单元（EU）</strong></p>
<p>上图中的指令控制单元从指令缓存中读取指令，将其分解为一系列<strong>微操作</strong>，即从内存中读数据，写数据，两个数字相加之类的操作</p>
<p>这些操作在现代处理器中通过复杂的结构，能够并行执行，并且是乱序执行，这样能够达成更好的<strong>指令级并行度</strong></p>
<h4 id="分支预测的处理"><a href="#分支预测的处理" class="headerlink" title="分支预测的处理"></a>分支预测的处理</h4><p>分支预测和前面一章中写的一样，这里在执行单元中使用分支单元检测预测是否正确，如果预测错误再将状态修改为之前的状态，我们称这种技术为<strong>投机执行</strong></p>
<p>分支点之后的所有指令的结果我们保存在退役单元中，如果指令执行完后判断预测正确，那么退役单元中的所有结果就可以落实修改到寄存器上，如果预测错误，那么所有结果就会被清空</p>
<h3 id="功能单元及其性能"><a href="#功能单元及其性能" class="headerlink" title="功能单元及其性能"></a>功能单元及其性能</h3><p>上面的各个功能单元往往功能不止一项，一个单元可以执行整数运算、浮点运算、乘、分支等多种功能，这样每个周期可以同时执行多种功能，这些资源将给程序带来巨大的性能影响</p>
<p><strong>延迟界限</strong>：一条指令必须等待上一条指令完成后才能进行，带来的限制<br><strong>吞吐量界限</strong>：根据处理器计算量的极限得到的最快速度</p>
<p><strong>单元性能的指标</strong>：</p>
<ul>
<li>延迟（latency）：完成运算花费的时间</li>
<li>发射（issue）：两个同类型指令之间最小需要的周期数</li>
<li>容量（capacity）：能够同时执行该指令的数量</li>
</ul>
<h4 id="处理器操作的抽象模型"><a href="#处理器操作的抽象模型" class="headerlink" title="处理器操作的抽象模型"></a>处理器操作的抽象模型</h4><p><img src="/image/CS/5_3.png"></p>
<p>上面是一组处理器指令CPE的指标，其整数乘法延迟界限为3.00，是由于issue和capacity都是1，那么消耗时间就为3.00，而加法的吞吐量界限为0.50，由于读写单元每个周期只能读入和写出两个数据，所以即便capacity为4，也只能有两个指令同时进行，所以throughput为0.5</p>
<p>之所以处理器会产生延迟界限，是因为指令的操作之间存在依赖关系，比如计算操作必须在加载操作之后执行，对于这些操作的<strong>数据相关</strong>我们可以通过数据流图来表示（微操作是乱序并行执行的，不是汇编指令一样一行一行）</p>
<p><img src="/image/CS/5_4.png"><br>combine4是进行了2*1循环展开以及代码移动优化的函数，但是其执行效率仍然没有超过延迟界限，接下来我们将从<strong>数据流图</strong>进行分析，从而找出代码的进一步优化方案，从而使代码效率更加接近吞吐量界限</p>
<p><strong>combine4中的循环部分</strong>：</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    acc <span class="token operator">=</span> acc OP data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p><strong>对应汇编代码</strong></p>
<pre class="language-asm" data-language="asm"><code class="language-asm">.L25:
    vmulsd (%rdx), %xmm0, %xmm0
    addq &lt;span class&#x3D;&quot;katex&quot;&gt;&lt;span class&#x3D;&quot;katex-mathml&quot;&gt;&lt;math xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1998&#x2F;Math&#x2F;MathML&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mn&gt;8&lt;&#x2F;mn&gt;&lt;mo separator&#x3D;&quot;true&quot;&gt;,&lt;&#x2F;mo&gt;&lt;mi&gt;c&lt;&#x2F;mi&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;p&lt;&#x2F;mi&gt;&lt;mi&gt;q&lt;&#x2F;mi&gt;&lt;mi&gt;j&lt;&#x2F;mi&gt;&lt;mi&gt;n&lt;&#x2F;mi&gt;&lt;mi&gt;e&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;.&lt;&#x2F;mi&gt;&lt;mi&gt;L&lt;&#x2F;mi&gt;&lt;mn&gt;25&lt;&#x2F;mn&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;‘&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;‘&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;‘&lt;&#x2F;mi&gt;&lt;mtext&gt;将其改写成数据流图之后如下：&lt;&#x2F;mtext&gt;&lt;mo stretchy&#x3D;&quot;false&quot;&gt;!&lt;&#x2F;mo&gt;&lt;mo stretchy&#x3D;&quot;false&quot;&gt;[&lt;&#x2F;mo&gt;&lt;mo stretchy&#x3D;&quot;false&quot;&gt;]&lt;&#x2F;mo&gt;&lt;mo stretchy&#x3D;&quot;false&quot;&gt;(&lt;&#x2F;mo&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;&#x2F;&lt;&#x2F;mi&gt;&lt;mi&gt;i&lt;&#x2F;mi&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;g&lt;&#x2F;mi&gt;&lt;mi&gt;e&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;&#x2F;&lt;&#x2F;mi&gt;&lt;mi&gt;C&lt;&#x2F;mi&gt;&lt;mi&gt;S&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;&#x2F;&lt;&#x2F;mi&gt;&lt;msub&gt;&lt;mn&gt;5&lt;&#x2F;mn&gt;&lt;mn&gt;5&lt;&#x2F;mn&gt;&lt;&#x2F;msub&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;.&lt;&#x2F;mi&gt;&lt;mi&gt;p&lt;&#x2F;mi&gt;&lt;mi&gt;n&lt;&#x2F;mi&gt;&lt;mi&gt;g&lt;&#x2F;mi&gt;&lt;mo stretchy&#x3D;&quot;false&quot;&gt;)&lt;&#x2F;mo&gt;&lt;mtext&gt;图中的&lt;&#x2F;mtext&gt;&lt;mi&gt;v&lt;&#x2F;mi&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;u&lt;&#x2F;mi&gt;&lt;mi&gt;l&lt;&#x2F;mi&gt;&lt;mi&gt;s&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mtext&gt;指令被分解成一个&lt;&#x2F;mtext&gt;&lt;mi&gt;l&lt;&#x2F;mi&gt;&lt;mi&gt;o&lt;&#x2F;mi&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mtext&gt;操作和一个&lt;&#x2F;mtext&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;u&lt;&#x2F;mi&gt;&lt;mi&gt;l&lt;&#x2F;mi&gt;&lt;mtext&gt;操作，而&lt;&#x2F;mtext&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mi&gt;q&lt;&#x2F;mi&gt;&lt;mtext&gt;是加上一个常数，所以只有一次&lt;&#x2F;mtext&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mtext&gt;操作，&lt;&#x2F;mtext&gt;&lt;mi&gt;c&lt;&#x2F;mi&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;p&lt;&#x2F;mi&gt;&lt;mi&gt;q&lt;&#x2F;mi&gt;&lt;mtext&gt;操作直接从&lt;&#x2F;mtext&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mtext&gt;的结果和对操作进行整理后如右图，去掉其余的分为&lt;&#x2F;mtext&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mtext&gt;只读寄存器&lt;&#x2F;mtext&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mtext&gt;、&lt;&#x2F;mtext&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mtext&gt;只写寄存器&lt;&#x2F;mtext&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mtext&gt;、&lt;&#x2F;mtext&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mtext&gt;局部寄存器&lt;&#x2F;mtext&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mo&gt;∗&lt;&#x2F;mo&gt;&lt;mtext&gt;（只在循环内部使用，比如条件码寄存器）由图可以看到，循环的进行主要有一个&lt;&#x2F;mtext&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;u&lt;&#x2F;mi&gt;&lt;mi&gt;l&lt;&#x2F;mi&gt;&lt;mtext&gt;和一个&lt;&#x2F;mtext&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mtext&gt;操作影响，并且两者之间存在数据相关，乘法的计算时间为&lt;&#x2F;mtext&gt;&lt;mn&gt;3&lt;&#x2F;mn&gt;&lt;mtext&gt;，而加法为&lt;&#x2F;mtext&gt;&lt;mn&gt;1&lt;&#x2F;mn&gt;&lt;mtext&gt;，所以程序的每个循环周期数为&lt;&#x2F;mtext&gt;&lt;mn&gt;3&lt;&#x2F;mn&gt;&lt;mtext&gt;接下来我们看看之前的循环展开后的汇编代码和数据流图：&lt;&#x2F;mtext&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;‘&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;‘&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;‘&lt;&#x2F;mi&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;s&lt;&#x2F;mi&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi mathvariant&#x3D;&quot;normal&quot;&gt;.&lt;&#x2F;mi&gt;&lt;mi&gt;L&lt;&#x2F;mi&gt;&lt;mn&gt;35&lt;&#x2F;mn&gt;&lt;mi&gt;v&lt;&#x2F;mi&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;u&lt;&#x2F;mi&gt;&lt;mi&gt;l&lt;&#x2F;mi&gt;&lt;mi&gt;s&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mo stretchy&#x3D;&quot;false&quot;&gt;(&lt;&#x2F;mo&gt;&lt;mi&gt;v&lt;&#x2F;mi&gt;&lt;mi&gt;u&lt;&#x2F;mi&gt;&lt;mi&gt;m&lt;&#x2F;mi&gt;&lt;mi&gt;l&lt;&#x2F;mi&gt;&lt;mi&gt;s&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mn&gt;8&lt;&#x2F;mn&gt;&lt;mo stretchy&#x3D;&quot;false&quot;&gt;(&lt;&#x2F;mo&gt;&lt;mi&gt;a&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mi&gt;d&lt;&#x2F;mi&gt;&lt;mi&gt;q&lt;&#x2F;mi&gt;&lt;&#x2F;mrow&gt;&lt;annotation encoding&#x3D;&quot;application&#x2F;x-tex&quot;&gt;8, %rdx
    cmpq %rax, %rdx
    jne .L25</code></pre><p>将其改写成数据流图之后如下：</p>
<p><img src="/image/CS/5_5.png"></p>
<p>图中的vmulsd指令被分解成一个load操作和一个mul操作，而addq是加上一个常数，所以只有一次add操作，cmpq操作直接从add的结果和%rax处取值，修改条件码寄存器给jne操作使用</p>
<p>对操作进行整理后如右图，去掉%rax及其相关操作后，剩下的部分便是循环的主要部分，%xmm和%rdx寄存器既作为读取的数据，又作为输出写的数据，我们称为<strong>循环寄存器</strong></p>
<p>其余的分为<strong>只读寄存器</strong>、<strong>只写寄存器</strong>、<strong>局部寄存器</strong>（只在循环内部使用，比如条件码寄存器）</p>
<p>由图可以看到，循环的进行主要有一个mul和一个add操作影响，并且两者之间存在数据相关，乘法的计算时间为3，而加法为1，所以程序的每个循环周期数为3</p>
<p>接下来我们看看之前的循环展开后的汇编代码和数据流图：</p>
<pre class="language-asm" data-language="asm"><code class="language-asm">.L35
    vmulsd (%rax, %rdx, 8), %xmm0, %xmm0
    vumlsd 8(%rax, %rdx, 8), %xmm0, %xmm0
    addq &lt;&#x2F;annotation&gt;&lt;&#x2F;semantics&gt;&lt;&#x2F;math&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;katex-html&quot; aria-hidden&#x3D;&quot;true&quot;&gt;&lt;span class&#x3D;&quot;base&quot;&gt;&lt;span class&#x3D;&quot;strut&quot; style&#x3D;&quot;height:1em;vertical-align:-0.25em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;8&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mpunct&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.1667em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;pq&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;jn&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;L&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;25‘‘‘&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;将其改写成数据流图之后如下：&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mclose&quot;&gt;!&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mopen&quot;&gt;[&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mclose&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mopen&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;ima&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;e&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.05764em;&quot;&gt;CS&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;5&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;msupsub&quot;&gt;&lt;span class&#x3D;&quot;vlist-t vlist-t2&quot;&gt;&lt;span class&#x3D;&quot;vlist-r&quot;&gt;&lt;span class&#x3D;&quot;vlist&quot; style&#x3D;&quot;height:0.3011em;&quot;&gt;&lt;span style&#x3D;&quot;top:-2.55em;margin-left:0em;margin-right:0.05em;&quot;&gt;&lt;span class&#x3D;&quot;pstrut&quot; style&#x3D;&quot;height:2.7em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;sizing reset-size6 size3 mtight&quot;&gt;&lt;span class&#x3D;&quot;mord mtight&quot;&gt;5&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;vlist-s&quot;&gt;​&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;vlist-r&quot;&gt;&lt;span class&#x3D;&quot;vlist&quot; style&#x3D;&quot;height:0.15em;&quot;&gt;&lt;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;n&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;g&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mclose&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;图中的&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;v&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.01968em;&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;指令被分解成一个&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.01968em;&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;操作和一个&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.01968em;&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;操作，而&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;dd&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;q&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;是加上一个常数，所以只有一次&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;dd&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;操作，&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;c&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;pq&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;操作直接从&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;dd&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;的结果和对操作进行整理后如右图，去掉其余的分为&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mbin&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;base&quot;&gt;&lt;span class&#x3D;&quot;strut&quot; style&#x3D;&quot;height:0.6833em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;只读寄存器&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mbin&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;base&quot;&gt;&lt;span class&#x3D;&quot;strut&quot; style&#x3D;&quot;height:0.6833em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;、&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mbin&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;base&quot;&gt;&lt;span class&#x3D;&quot;strut&quot; style&#x3D;&quot;height:0.6833em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;只写寄存器&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mbin&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;base&quot;&gt;&lt;span class&#x3D;&quot;strut&quot; style&#x3D;&quot;height:0.6833em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;、&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mbin&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;base&quot;&gt;&lt;span class&#x3D;&quot;strut&quot; style&#x3D;&quot;height:0.6833em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;局部寄存器&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mbin&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mspace&quot; style&#x3D;&quot;margin-right:0.2222em;&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;base&quot;&gt;&lt;span class&#x3D;&quot;strut&quot; style&#x3D;&quot;height:1em;vertical-align:-0.25em;&quot;&gt;&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;∗&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;（只在循环内部使用，比如条件码寄存器）由图可以看到，循环的进行主要有一个&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.01968em;&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;和一个&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;dd&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;操作影响，并且两者之间存在数据相关，乘法的计算时间为&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;3&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;，而加法为&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;，所以程序的每个循环周期数为&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;3&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord cjk_fallback&quot;&gt;接下来我们看看之前的循环展开后的汇编代码和数据流图：&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;‘‘‘&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;L&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;35&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;v&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;u&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.01968em;&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mopen&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;vu&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;m&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.01968em;&quot;&gt;l&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;s&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;d&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord&quot;&gt;8&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mopen&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot;&gt;dd&lt;&#x2F;span&gt;&lt;span class&#x3D;&quot;mord mathnormal&quot; style&#x3D;&quot;margin-right:0.03588em;&quot;&gt;q&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;2, %rdx
    cmpq %rdx, %rbp
    jg .L35</code></pre><p><img src="/image/CS/5_6.png"></p>
<p>由上可见，2*1的循环展开依然需要执行连续的mul指令，其速度依然被乘法操作限制<br>现在我们将代码修改为下面的combine6<br><strong>combine6中的循环部分</strong>：</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    acc1 <span class="token operator">=</span> acc1 OP data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    acc2 <span class="token operator">=</span> acc2 OP data<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>
acc <span class="token operator">=</span> acc1 <span class="token operator">+</span> acc2<span class="token punctuation">;</span></code></pre><p>这样一来，循环部分的汇编代码便成为：</p>
<pre class="language-asm" data-language="asm"><code class="language-asm">.L35
    vmulsd (%rax, %rdx, 8), %xmm0, %xmm0
    vmulsd 8(%rax, %rdx, 8), %xmm1, %xmm1
    addq $2, %rdx
    cmpq %rdx, %rbp
    jg .L35</code></pre><p>这里的汇编代码与combine5基本一致，但是第二次乘法指令的寄存器是%xmm1，画成数据流图后如下所示：</p>
<p><img src="/image/CS/5_7.png"></p>
<p>在两个不同的寄存器上进行累加，使得一条关键路径变成两条，并且两次乘法操作之间没有相关依赖，这样一来，循环的时间便得到了减半</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    acc1 <span class="token operator">=</span> acc1 <span class="token function">OP</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> OP data<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>上面这种写法也有关键路径的优化：</p>
<p><img src="/image/CS/5_8.png"></p>
<p>通过2<em>2的多路循环展开，可以有效加快程序的速度，如果我们按照这样的方式进行3*3乃至更多的10*10循环展开，程序的效率将会无限接近于*<em>吞吐量界限</em></em></p>
<h3 id="寄存器溢出"><a href="#寄存器溢出" class="headerlink" title="寄存器溢出"></a>寄存器溢出</h3><p>指令级的并行需要在多个寄存器上进行计算，x86-64处理器有16个寄存器使用，如果使用超过16路并行的展开，处理器就不得不在内存中开辟空间来实现，这样的速度远不如寄存器中的计算速度，反而会拖累程序的整体运行速度，我们称之为<strong>寄存器溢出</strong></p>
<h3 id="预测错误的惩罚"><a href="#预测错误的惩罚" class="headerlink" title="预测错误的惩罚"></a>预测错误的惩罚</h3><p>在程序分支预测错误时，需要清除流水线中的指令，并重新填充，这必然是相当费时间的<br>在有规律可循的条件分支，比如循环的条件判断中，有效的预测往往可以正确选择分支并减少时间，但是面对一些随机的条件分支，不使用投机执行而是等待条件判断完成再跳转，会是更加有效的方式</p>
<p>所以在编写代码时，我们可以刻意编写让编译器趋向于使用条件数据转移的代码，比如说使用三目运算符来做条件数据转移，我们称这样的代码更具有“功能性”</p>
<h3 id="内存的性能"><a href="#内存的性能" class="headerlink" title="内存的性能"></a>内存的性能</h3><p>关于内存的性能限制，我们考虑下面这种情况</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">long</span> <span class="token function">list_len</span><span class="token punctuation">(</span>list_ptr ls<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>ls<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        len<span class="token operator">++</span><span class="token punctuation">;</span>
        ls <span class="token operator">=</span> ls<span class="token operator">-></span>next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre><p>这里的ls每次循环都和自己存在数据相关，在汇编代码中即<code>movq (%rdi), %rdi</code>这样的指令，需要上一次的移动指令之后才能执行，每个时钟周期只能读取一个指令，完成一个元素的转移需要4个时钟周期，CPE为4</p>
<p>类似的在不同寄存器之间存在数据相关的情况，也会限制程序的性能，形成更长的关键路径，减小程序指令级的并行</p>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
</div>

<div id="paginator">
  
</div>


  <!-- scripts list from theme config.yml -->
  
  <script src="/js/post/mermaid.js"></script>
  
  
    </div>

  </div>



  
  <!-- scripts list from theme config.yml -->
  
  <script src="/js/layout/animation.js"></script>
  
  <script src="/js/layout/svg.js"></script>
  
  <script src="/js/csstool.js"></script>
  
  

</body>

</html>